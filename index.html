<html>
<head>
    <meta charset="utf-8"/>
    <script src="./wasm_exec.js"></script>
    <style type="text/css">
        #canvas-pixelate {
            width: 600px;
            height: 600px;
        }
    </style>
</head>
<body>
<video id="video" width="200" height="200"></video>
<canvas id="canvas" width="200" height="200" style="display: none"></canvas>
<canvas id="canvas-pixelate" width="200" height="200"></canvas>
<script>
    const canvas = document.getElementById('canvas')
    const ctx = canvas.getContext('2d')
    const video = document.getElementById('video')

    async function showStream() {
        video.srcObject = await this._getStream()
        video.addEventListener('loadedmetadata', () => {
            video.play()
            window.requestAnimationFrame(() => sync(video, ctx))
        })
    }

    function _getStream() {
        const config = {
            video: {
                audio: false,
                width: 200,
                height: 200
                // facingMode: { exact: 'environment' }
            }
        }
        return navigator.mediaDevices.getUserMedia(config)
    }

    function sync(video, ctx) {
        ctx.drawImage(video, 0, 0, 200, 200)
        // go.run(goResult.instance)
        window.requestAnimationFrame(() => sync(video, ctx))
    }

    const go = new Go();
    let goResult

    WebAssembly.instantiateStreaming(fetch("./main.wasm"), go.importObject).then((result) => {
        goResult = result
        showStream()
        go.run(result.instance);
    });
</script>
</body>
</html>
